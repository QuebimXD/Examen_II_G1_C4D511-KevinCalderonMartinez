---
title: "Parte de excel"
author: "Kevin David Calderon Martinez"
format: pdf
fontsize: 12pt
mainfont: "Arial"
geometry: "margin = 2.54cm"
colorlinks: true
urlcolor: blue
linestretch: 1.5
include-in-header:
  text: |
      \usepackage{indentfirst}
      \usepackage{hanging}
      \usepackage{caption}
      \usepackage{titling}
       
      \setlength{\parindent}{1.27cm}
      \setlength{\parskip}{0pt}
      \captionsetup[table]{name=Tabla}
      \captionsetup[table]{font=small}
      \captionsetup[figure]{name=Figura}
      \captionsetup[figure]{font=small}
      
      \addtokomafont{section}{\rmfamily}
      \addtokomafont{subsection}{\rmfamily}
      \addtokomafont{subsubsection}{\rmfamily}
      
      \RedeclareSectionCommand[
        beforeskip=1pt,
        afterskip=1pt
      ]{section}

      \RedeclareSectionCommand[
        beforeskip=4pt,
        afterskip=4pt
      ]{subsection}

      \RedeclareSectionCommand[
        beforeskip=3pt,
        afterskip=3pt
      ]{subsubsection}
      
      \pretitle{\begin{center}\fontsize{18pt}{20pt}\selectfont\bfseries}
      \posttitle{\par\end{center}}
      
      \preauthor{\begin{center}\fontsize{12pt}{14pt}\selectfont}
      \postauthor{\par\end{center}}
      \predate{\begin{center}\fontsize{12pt}{14pt}\selectfont}
      \postdate{\par\end{center}}      
---

Primero, leemos la base de datos.

```{r, echo = FALSE, warning = FALSE, message = FALSE}
library(here)

datos <- read.table(here("data", "moras.txt"), header = TRUE, sep = ",", dec = ".", stringsAsFactors = FALSE )

```


## Ejercicio 2


```{r, echo = FALSE, warning = FALSE, message = FALSE}

datos$SALARIO <- gsub("\"", "", datos$SALARIO)      
datos$SALARIO <- gsub(",", ".", datos$SALARIO) 
datos$SALARIO <- as.numeric(datos$SALARIO) 

resumen <- data.frame(
  MEDIDOR = c("MINIMO", "MAXIMO", "CUARTIL_1", "MEDIANA", "CUARTIL_3", "PROMEDIO"),
  SALARIO = c(
    min(datos$SALARIO, na.rm = TRUE),
    max(datos$SALARIO, na.rm = TRUE),
    quantile(datos$SALARIO, 0.25, na.rm = TRUE),
    median(datos$SALARIO, na.rm = TRUE),
    quantile(datos$SALARIO, 0.75, na.rm = TRUE),
    mean(datos$SALARIO, na.rm = TRUE)
  ),
  EDAD = c(
    min(datos$EDAD, na.rm = TRUE),
    max(datos$EDAD, na.rm = TRUE),
    quantile(datos$EDAD, 0.25, na.rm = TRUE),
    median(datos$EDAD, na.rm = TRUE),
    quantile(datos$EDAD, 0.75, na.rm = TRUE),
    mean(datos$EDAD, na.rm = TRUE)
  )
)
knitr::kable(resumen, caption = "Resumen de 5 numeros y promedio.")
```

## Ejercicio 3

```{r, echo = FALSE, warning = FALSE, message = FALSE}
library(dplyr)

datos <- datos %>%
  mutate(
    Z_SALARIO = (SALARIO - mean(SALARIO, na.rm = TRUE)) / sd(SALARIO, na.rm = TRUE),
    OUTLIER_SALARIO = ifelse(abs(Z_SALARIO) > 1.96, "OUTLIER", "NO"),

    Z_EDAD = (EDAD - mean(EDAD, na.rm = TRUE)) / sd(EDAD, na.rm = TRUE),
    OUTLIER_EDAD = ifelse(abs(Z_EDAD) > 1.96, "OUTLIER", "NO")
  )
zscore <- datos %>% 
  select(Z_SALARIO, OUTLIER_SALARIO, Z_EDAD, OUTLIER_EDAD) %>% 
  head(10)
knitr::kable(zscore, caption = "Aplicacion del Z-score.")
```

## Ejercicio 4

```{r, echo = FALSE, warning = FALSE, message = FALSE}
porcentaje_na <- sapply(datos, function(x) {
  sum(is.na(x)) / length(x) * 100
})
na <- data.frame(
  COLUMNA = names(porcentaje_na),
  PORCENTAJE = round(porcentaje_na, 2)
)
knitr::kable(na, caption = "Porcentaje de valores nulos en cada columna.")
```

## Ejercicio 5

```{r, echo = FALSE, warning = FALSE, message = FALSE}

datos <- datos %>%
  mutate(
    SALARIO_IMPUT = ifelse(
      is.na(SALARIO) | SALARIO == "",
      mean(as.numeric(SALARIO), na.rm = TRUE),
      SALARIO
    ),
    
    EDAD_IMPUT = ifelse(
      is.na(EDAD) | EDAD == "",
      round(mean(as.numeric(EDAD), na.rm = TRUE)),
      EDAD
    ),
    
    TIPO_ASEGURAMIENTO_IMPUT = ifelse(
      is.na(TIPO_ASEGURAMIENTO) | TIPO_ASEGURAMIENTO == "",
      "DESCONOCIDO",
      TIPO_ASEGURAMIENTO
    )
  )

imputs <- datos %>% 
  select (SALARIO_IMPUT, EDAD_IMPUT, TIPO_ASEGURAMIENTO_IMPUT) %>% 
  head(10)

knitr::kable(imputs, caption = "Datos imputados por las columnas vacias.")

```

## Ejercicio 6

```{r, echo = FALSE, warning = FALSE, message = FALSE}
conteo_categoria <- function(df, variable) {
  df %>%
    group_by(across({{variable}})) %>%
    summarise(CONTEO = n(), .groups = "drop")
}
conteo_sexo <- conteo_categoria(datos, SEXO)
conteo_tipo <- conteo_categoria(datos, TIPO_ASEGURAMIENTO)
conteo_sector <- conteo_categoria(datos, SECTOR)
conteo_activo <- conteo_categoria(datos, INDICADOR_ACTIVO)
conteo_extranjero <- conteo_categoria(datos, INDICADOR.EXTRANJERO)
conteo_moroso <- conteo_categoria(datos, INDICADOR_MOROSO)

library(ggplot2)

library(ggplot2)
library(dplyr)

guardar_grafico_categoria <- function(df, variable, titulo, archivo, horizontal = FALSE) {
  p <- ggplot(df, aes(x = .data[[variable]], 
                      y = CONTEO, 
                      fill = .data[[variable]])) +
    geom_col() +
    geom_text(aes(label = CONTEO),
              vjust = ifelse(horizontal, 0.5, -0.3),
              hjust = ifelse(horizontal, -0.2, 0.5),
              angle = ifelse(horizontal, 270, 0),
              size = 4) +
    labs(title = titulo, x = "", y = "Frecuencia") +
    theme_minimal(base_size = 13) +
    theme(legend.position = "none")
  if (horizontal) {
    p <- p + coord_flip()
    ggsave(filename = archivo, plot = p, width = 8, height = 10, dpi = 300)
  }else{
    ggsave(filename = archivo, plot = p, width = 5, height = 7, dpi = 300)
  }
  
}

```


```{r, echo = FALSE, warning = FALSE, message = FALSE}
guardar_grafico_categoria(
  df = conteo_tipo,
  variable = "TIPO_ASEGURAMIENTO",
  titulo = "Frecuencia por Tipo de Aseguramiento",
  archivo = here("res","tipo_aseguramiento.pdf" ),
  horizontal = TRUE
)


```

![Grafico de la distribucion de asegurados de acuerdo al tipo](../res/tipo_aseguramiento.pdf)

Como se puede observar, casi el 80% de los asegurados son asalariados. Por lo que la mayoria se encuentra en situacion de empleado. El de menor frecuencia tiene que ver con el convenio de los asegurados voluntarios. Tambien se aprecia que hay mas trabajadores independientes asegurados, que los asegurados voluntarios.

```{r, echo = FALSE, warning = FALSE, message = FALSE}
guardar_grafico_categoria(
  df = conteo_sexo,
  variable = "SEXO",
  titulo = "Frecuencia por Sexo",
  archivo = here("res","sexo.pdf" ),
  horizontal = FALSE
)


```

![Grafico de la distribucion de asegurados de acuerdo al sexo](../res/sexo.pdf)

Note que poco mas del 60% de los asegurados son hombres, lo cual contrasta en una diferencia de mas de un 20% con las mujeres aseguradas.

```{r, echo = FALSE, warning = FALSE, message = FALSE}
guardar_grafico_categoria(
  df = conteo_sector,
  variable = "SECTOR",
  titulo = "Frecuencia por sector",
  archivo = here("res","sector.pdf" ),
  horizontal = FALSE
)

```

![Grafico de la distribucion de asegurados de acuerdo al sector del asegurado](../res/sector.pdf)

Poco mas de un 20% de empleados son del sector publico, por lo que hay una gran brecha entre la cantidad de empleados del sector publico y privado.

```{r, echo = FALSE, warning = FALSE, message = FALSE}
guardar_grafico_categoria(
  df = conteo_activo,
  variable = "INDICADOR_ACTIVO",
  titulo = "Frecuencia por seguro activo o inactivo",
  archivo = here("res","activo.pdf" ),
  horizontal = FALSE
)

```

![Grafico de la distribucion de asegurados de acuerdo a si el seguro se encuentra activo o no](../res/activo.pdf)

Aquí casi la totalidad de los asegurados poseen su paquete en estado Activo. Solo 34 personas no tienen su seguro activo. Esto es positivo, debido a que hay poco margen de asegurados sin forma de acceder a su seguro, pues se encuentra inactivo.

```{r, echo = FALSE, warning = FALSE, message = FALSE}
guardar_grafico_categoria(
  df = conteo_extranjero,
  variable = "INDICADOR.EXTRANJERO",
  titulo = "Frecuencia por extranjero",
  archivo = here("res","extranjero.pdf" ),
  horizontal = FALSE
)

```

![Grafico de la distribucion de asegurados de acuerdo a si el usuario del seguro es extranjero o no](../res/extranjero.pdf)

Hay una baja cantidad de asegurados extranjeros. Esto se puede explicar de muchas formas: El seguro esta mas enfocado a servicios de residentes, y no tan enfocados al turismo.  Por ende, hay una gran diferencia entre los asegurados que son y no son extranjeros.

```{r, echo = FALSE, warning = FALSE, message = FALSE}
guardar_grafico_categoria(
  df = conteo_moroso,
  variable = "INDICADOR_MOROSO",
  titulo = "Frecuencia por morosidad",
  archivo = here("res","moroso.pdf" ),
  horizontal = FALSE
)

```

![Grafico de la distribucion de asegurados de acuerdo a si el usuario del seguro es moroso o no](../res/moroso.pdf)

Mas del 80% de los asegurados han realizado los pagos de sus obligaciones de manera responsable. Hay 870 de asegurados que han impagado sus seguros. Si bien esta cifra es considerable, no comprende mas del 20% del total de asegurados, lo cual es un dato alentador para el factor incertidumbre de la aseguradora.


## Ejercicio 7

```{r, echo = FALSE, warning = FALSE, message = FALSE}
resumen_morosos <- function(df, variable) {
  df %>%
    group_by(.data[[variable]]) %>%
    summarise(
      TOTAL = n(),
      MOROSOS = sum(INDICADOR_MOROSO == "SI"),
      PORCENTAJE = round((MOROSOS / TOTAL) * 100, 2)
    ) %>%
    rename(CATEGORIA = .data[[variable]])
}

abrev_aseguramiento <- c(
  "ASALARIADO" = "ASAL",
  "PENSIONADOS EN SU PROPIO SISTEMA" = "PEN",
  "ASEGURADO VOLUNTARIO" = "VOL",
  "TRABAJADOR INDEPENDIENTE" = "IND",
  "CONVENIOS ESPECIALES DE TRABAJADORES INDEPENDIENTES" = "CEI",
  "CONVENIOS ESPECIALES DE ASEGURADOS VOLUNTARIOS" = "CEV"
)

guardar_grafico_morosos <- function(df, variable, archivo) {
  datos <- resumen_morosos(df, variable)
  if (variable == "TIPO_ASEGURAMIENTO") {
    datos$CATEGORIA <- abrev_aseguramiento[datos$CATEGORIA]
  }
  p <- ggplot(datos, aes(x = CATEGORIA, y = PORCENTAJE, fill = CATEGORIA)) +
    geom_col() +
    geom_text(aes(label = paste0(PORCENTAJE, "%")),
              vjust = -0.3,
              size = 4) +
    theme_minimal(base_size = 13) +
    theme(legend.position = "none") +
    labs(y = "% Morosos", x = "")
  ggsave(archivo, p, width = 8, height = 5, dpi = 300)
}

```
 
```{r, echo = FALSE, warning = FALSE, message = FALSE}
guardar_grafico_morosos(datos, "TIPO_ASEGURAMIENTO", here("res", "morosos_tipo_aseguramiento.pdf"))
guardar_grafico_morosos(datos, "SEXO", here("res", "morosos_sexo.pdf"))
guardar_grafico_morosos(datos, "SECTOR", here("res", "morosos_sector.pdf"))
guardar_grafico_morosos(datos, "INDICADOR_ACTIVO", here("res", "morosos_activo.pdf"))
guardar_grafico_morosos(datos, "INDICADOR.EXTRANJERO", here("res", "morosos_extranjero.pdf"))
```

![Grafico de la porcentaje de asegurados morosos de acuerdo al tipo de seguro](../res/morosos_tipo_aseguramiento.pdf) 

![Grafico de la porcentaje de asegurados morosos de acuerdo al sexo](../res/morosos_sexo.pdf) 

![Grafico de la porcentaje de asegurados morosos de acuerdo al sector](../res/morosos_sector.pdf) 

![Grafico de la porcentaje de asegurados morosos de acuerdo a si el seguro esta activo o no](../res/morosos_activo.pdf)

![Grafico de la porcentaje de asegurados morosos de acuerdo a si el cliente es extranjero o no](../res/morosos_extranjero.pdf)


Como puede observar, en los graficos se muestran las distribuciones de cada categoría de acuerdo al porcentaje de morosidad. Los datos a destacar es el porcentaje de morosos de trabajadores independientes, extranjeros, seguros inactivos; son porcentajes altos. Se puede entender en que mas de la mitad de seguros impagados sean inactivos, pero se debe verificar las obligaciones de los clientes morosos extranjeros y los morosos masculinos. Los demás porcentajes no superan el 20%, lo cual es una cifra alentadora.

